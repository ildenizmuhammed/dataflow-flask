<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clubhouse Spaces - Sesli Sohbet OdalarÄ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='webrtc.js') }}"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .logout-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .auth-menu {
            display: flex;
            align-items: center;
        }
        
        .auth-menu-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .auth-menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(78, 205, 196, 0.3);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Auth Section */
        .auth-section {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
        }
        
        .auth-section.active {
            display: flex;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
        }
        
        .auth-tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .auth-tab.active {
            color: #fff;
            border-bottom-color: #4ecdc4;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4ecdc4;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .form-group input::placeholder, .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Dashboard */
        .dashboard {
            display: block;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .create-room-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .create-room-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }
        
        /* Rooms Grid */
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .room-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .room-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .room-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .room-description {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .room-stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        .room-owner {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .owner-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .owner-name {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .join-room-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            width: 100%;
        }
        
        .join-room-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(78, 205, 196, 0.3);
        }
        
        .join-room-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Room View */
        .room-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
        }
        
        .room-view.active {
            display: flex;
            flex-direction: column;
        }
        
        .room-header-bar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .room-title-large {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .room-participant-count {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        .room-controls {
            display: flex;
            gap: 1rem;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .control-btn.danger {
            background: rgba(255, 107, 107, 0.2);
            border-color: rgba(255, 107, 107, 0.3);
        }
        
        .control-btn.danger:hover {
            background: rgba(255, 107, 107, 0.3);
        }
        
        /* Participants Circle */
        .participants-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .participants-circle {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            max-width: 800px;
        }
        
        .participant-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            color: white;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .participant-avatar:hover {
            transform: scale(1.1);
        }
        
        .participant-avatar.speaking {
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.6);
            border: 3px solid #4ecdc4;
        }
        
        .participant-avatar.muted {
            opacity: 0.6;
        }
        
        .participant-avatar.owner {
            border: 3px solid #ffd700;
        }
        
        .participant-name {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }
        
        .participant-status {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .status-speaking {
            background: #4ecdc4;
            color: #000;
        }
        
        .status-muted {
            background: #ff6b6b;
            color: #fff;
        }
        
        .status-owner {
            background: #ffd700;
            color: #000;
        }
        
        /* Bottom Controls */
        .bottom-controls {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .speak-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .speak-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(78, 205, 196, 0.3);
        }
        
        .speak-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .mute-btn {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }
        
        .mute-btn:hover {
            background: rgba(255, 107, 107, 0.3);
        }
        
        .request-speak-btn {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }
        
        .request-speak-btn:hover {
            background: rgba(255, 193, 7, 0.3);
        }
        
        /* Speaking Requests Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .request-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .request-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .approve-btn {
            background: #4ecdc4;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .reject-btn {
            background: #ff6b6b;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Status Messages */
        .status-message {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .status-message.show {
            transform: translateX(0);
        }
        
        .status-message.success {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid rgba(78, 205, 196, 0.3);
            color: #4ecdc4;
        }
        
        .status-message.error {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }
        
        .status-message.info {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .rooms-grid {
                grid-template-columns: 1fr;
            }
            
            .participants-circle {
                gap: 0.5rem;
            }
            
            .participant-avatar {
                width: 60px;
                height: 60px;
                font-size: 1rem;
            }
            
            .bottom-controls {
                padding: 1rem;
                flex-wrap: wrap;
            }
            
            .room-header-bar {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header" id="header">
            <div class="header-content">
                <div class="logo">ðï¸ Clubhouse Spaces</div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-name" id="userName">KullanÄ±cÄ±</div>
                    <button class="logout-btn" id="logoutBtn">ÃÄ±kÄ±Å</button>
                </div>
                <div class="auth-menu" id="authMenu">
                    <button class="auth-menu-btn" id="authMenuBtn">
                        <i class="fas fa-user"></i> GiriÅ Yap
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Auth Section -->
            <div class="auth-section" id="authSection">
                <div class="auth-card">
                    <div class="auth-tabs">
                        <button class="auth-tab active" data-tab="login">GiriÅ</button>
                        <button class="auth-tab" data-tab="register">KayÄ±t</button>
                    </div>
                    
                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form">
                        <div class="form-group">
                            <label for="loginUsername">KullanÄ±cÄ± AdÄ±</label>
                            <input type="text" id="loginUsername" name="username" required placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin">
                        </div>
                        <button type="submit" class="btn">GiriÅ Yap</button>
                    </form>
                    
                    <!-- Register Form -->
                    <form id="registerForm" class="auth-form" style="display: none;">
                        <div class="form-group">
                            <label for="registerUsername">KullanÄ±cÄ± AdÄ±</label>
                            <input type="text" id="registerUsername" name="username" required placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin">
                        </div>
                        <div class="form-group">
                            <label for="registerDisplayName">GÃ¶rÃ¼nen Ad</label>
                            <input type="text" id="registerDisplayName" name="display_name" required placeholder="GÃ¶rÃ¼nen adÄ±nÄ±zÄ± girin">
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">E-posta (Ä°steÄe baÄlÄ±)</label>
                            <input type="email" id="registerEmail" name="email" placeholder="E-posta adresinizi girin">
                        </div>
                        <button type="submit" class="btn">KayÄ±t Ol</button>
                    </form>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="dashboard" id="dashboard">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Sesli Sohbet OdalarÄ±</h1>
                    <button class="create-room-btn" id="createRoomBtn" onclick="handleCreateRoomClick()">
                        <i class="fas fa-plus"></i> Oda OluÅtur
                    </button>
                </div>
                
                <div class="rooms-grid" id="roomsGrid">
                    <!-- Rooms will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Room View -->
        <div class="room-view" id="roomView">
            <div class="room-header-bar">
                <div class="room-info">
                    <h2 class="room-title-large" id="roomTitle">Oda AdÄ±</h2>
                    <span class="room-participant-count" id="roomParticipantCount">0 katÄ±lÄ±mcÄ±</span>
                </div>
                <div class="room-controls">
                    <button class="control-btn" id="inviteBtn">
                        <i class="fas fa-user-plus"></i> Davet Et
                    </button>
                    <button class="control-btn" id="requestsBtn" style="display: none;">
                        <i class="fas fa-hand-paper"></i> Ä°stekler
                    </button>
                    <button class="control-btn danger" id="closeRoomBtn" style="display: none;">
                        <i class="fas fa-times"></i> OdayÄ± Kapat
                    </button>
                    <button class="control-btn danger" id="leaveRoomBtn">
                        <i class="fas fa-sign-out-alt"></i> Odadan ÃÄ±k
                    </button>
                </div>
            </div>
            
            <div class="participants-container">
                <div class="participants-circle" id="participantsCircle">
                    <!-- Participants will be loaded here -->
                </div>
            </div>
            
            <div class="bottom-controls">
                <button class="speak-btn" id="speakBtn" style="display: none;">
                    <i class="fas fa-microphone"></i> KonuÅ
                </button>
                <button class="speak-btn mute-btn" id="muteBtn" style="display: none;">
                    <i class="fas fa-microphone-slash"></i> Sustur
                </button>
                <button class="speak-btn request-speak-btn" id="requestSpeakBtn">
                    <i class="fas fa-hand-paper"></i> KonuÅma Ä°ste
                </button>
            </div>
        </div>

        <!-- Create Room Modal -->
        <div class="modal" id="createRoomModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Yeni Oda OluÅtur</h3>
                    <button class="close-btn" id="closeCreateModal">&times;</button>
                </div>
                <form id="createRoomForm">
                    <div class="form-group">
                        <label for="roomName">Oda AdÄ±</label>
                        <input type="text" id="roomName" name="name" required placeholder="Oda adÄ±nÄ± girin">
                    </div>
                    <div class="form-group">
                        <label for="roomDescription">AÃ§Ä±klama</label>
                        <textarea id="roomDescription" name="description" rows="3" placeholder="Oda hakkÄ±nda aÃ§Ä±klama..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="roomType">Oda TÃ¼rÃ¼</label>
                        <select id="roomType" name="is_public">
                            <option value="true">Herkese AÃ§Ä±k</option>
                            <option value="false">Ãzel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maxParticipants">Maksimum KatÄ±lÄ±mcÄ±</label>
                        <input type="number" id="maxParticipants" name="max_participants" value="50" min="2" max="100">
                    </div>
                    <button type="submit" class="btn">Oda OluÅtur</button>
                </form>
            </div>
        </div>

        <!-- Speaking Requests Modal -->
        <div class="modal" id="requestsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">KonuÅma Ä°stekleri</h3>
                    <button class="close-btn" id="closeRequestsModal">&times;</button>
                </div>
                <div id="requestsList">
                    <!-- Requests will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Invite Modal -->
        <div class="modal" id="inviteModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Davet Kodu OluÅtur</h3>
                    <button class="close-btn" id="closeInviteModal">&times;</button>
                </div>
                <div id="inviteContent">
                    <p>Bu oda iÃ§in bir davet kodu oluÅturuluyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // Socket.IO baÄlantÄ±sÄ±
        const socket = io();
        
        // Global state
        let currentUser = null;
        let currentRoom = null;
        let currentMember = null;
        let isSpeaking = false;
        let isMuted = false;
        
        // DOM elements
        const authSection = document.getElementById('authSection');
        const header = document.getElementById('header');
        const dashboard = document.getElementById('dashboard');
        const roomView = document.getElementById('roomView');
        const statusMessage = document.getElementById('statusMessage');
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadRooms(); // Sayfa yÃ¼klendiÄinde odalarÄ± gÃ¶ster
            checkAuth();
            setupEventListeners();
        });
        
        // Check authentication status
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    currentUser = await response.json();
                    showUserInfo();
                } else {
                    showAuthMenu();
                }
            } catch (error) {
                showAuthMenu();
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchAuthTab(this.dataset.tab);
                });
            });
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Register form
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Create room
            document.getElementById('createRoomForm').addEventListener('submit', handleCreateRoom);
            document.getElementById('closeCreateModal').addEventListener('click', hideCreateRoomModal);
            
            // Auth menu
            document.getElementById('authMenuBtn').addEventListener('click', showAuthModal);
            
            // Room controls
            document.getElementById('leaveRoomBtn').addEventListener('click', handleLeaveRoom);
            document.getElementById('closeRoomBtn').addEventListener('click', handleCloseRoom);
            document.getElementById('inviteBtn').addEventListener('click', handleInvite);
            document.getElementById('requestsBtn').addEventListener('click', showRequestsModal);
            document.getElementById('closeRequestsModal').addEventListener('click', hideRequestsModal);
            document.getElementById('closeInviteModal').addEventListener('click', hideInviteModal);
            
            // Speaking controls
            document.getElementById('speakBtn').addEventListener('click', handleSpeak);
            document.getElementById('muteBtn').addEventListener('click', handleMute);
            document.getElementById('requestSpeakBtn').addEventListener('click', handleRequestSpeak);
        }
        
        // Auth functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.auth-form').forEach(form => form.style.display = 'none');
            document.getElementById(`${tab}Form`).style.display = 'block';
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: formData.get('username')
                    })
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    showUserInfo();
                    hideAuthModal();
                    showStatus('GiriÅ baÅarÄ±lÄ±!', 'success');
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'GiriÅ hatasÄ±!', 'error');
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: formData.get('username'),
                        display_name: formData.get('display_name'),
                        email: formData.get('email') || null
                    })
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    showUserInfo();
                    hideAuthModal();
                    showStatus('KayÄ±t baÅarÄ±lÄ±!', 'success');
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'KayÄ±t hatasÄ±!', 'error');
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                currentUser = null;
                currentRoom = null;
                currentMember = null;
                showAuthMenu();
                showStatus('ÃÄ±kÄ±Å yapÄ±ldÄ±!', 'info');
            } catch (error) {
                showStatus('ÃÄ±kÄ±Å hatasÄ±!', 'error');
            }
        }
        
        // UI functions
        function showAuthMenu() {
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('authMenu').style.display = 'flex';
        }
        
        function showUserInfo() {
            document.getElementById('authMenu').style.display = 'none';
            document.getElementById('userInfo').style.display = 'flex';
            
            // Update user info
            document.getElementById('userAvatar').textContent = currentUser.display_name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = currentUser.display_name;
        }
        
        function showAuthModal() {
            document.getElementById('authSection').classList.add('active');
        }
        
        function hideAuthModal() {
            document.getElementById('authSection').classList.remove('active');
        }
        
        function showDashboard() {
            authSection.classList.remove('active');
            dashboard.classList.add('active');
            roomView.classList.remove('active');
            loadRooms();
        }
        
        function showRoom(room) {
            currentRoom = room;
            roomView.classList.add('active');
            dashboard.classList.remove('active');
            
            document.getElementById('roomTitle').textContent = room.name;
            document.getElementById('roomParticipantCount').textContent = `${room.current_participants} katÄ±lÄ±mcÄ±`;
            
            // Show/hide owner controls
            const isOwner = room.owner_id === currentUser.id;
            document.getElementById('requestsBtn').style.display = isOwner ? 'block' : 'none';
            document.getElementById('closeRoomBtn').style.display = isOwner ? 'block' : 'none';
            document.getElementById('leaveRoomBtn').style.display = isOwner ? 'none' : 'block';
            
            loadRoomMembers();
        }
        
        // Auth control functions
        function handleJoinRoom(roomId) {
            if (!currentUser) {
                showAuthModal();
                showStatus('Odaya katÄ±lmak iÃ§in giriÅ yapmalÄ±sÄ±nÄ±z!', 'error');
                return;
            }
            joinRoom(roomId);
        }
        
        function handleCreateRoomClick() {
            if (!currentUser) {
                showAuthModal();
                showStatus('Oda oluÅturmak iÃ§in giriÅ yapmalÄ±sÄ±nÄ±z!', 'error');
                return;
            }
            showCreateRoomModal();
        }
        
        // Room functions
        async function loadRooms() {
            try {
                const response = await fetch('/api/rooms');
                const rooms = await response.json();
                
                const roomsGrid = document.getElementById('roomsGrid');
                if (rooms.length === 0) {
                    roomsGrid.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); grid-column: 1/-1;">HenÃ¼z aktif oda yok. Ä°lk odayÄ± siz oluÅturun!</p>';
                } else {
                    roomsGrid.innerHTML = rooms.map(room => `
                        <div class="room-card" onclick="joinRoom('${room.id}')">
                            <div class="room-header">
                                <div>
                                    <h3 class="room-title">${room.name}</h3>
                                    <p class="room-description">${room.description || 'AÃ§Ä±klama yok'}</p>
                                </div>
                                <div class="room-stats">
                                    <i class="fas fa-users"></i> ${room.current_participants}/${room.max_participants}
                                </div>
                            </div>
                            <div class="room-owner">
                                <div class="owner-avatar">${room.owner_name.charAt(0).toUpperCase()}</div>
                                <span class="owner-name">${room.owner_name}</span>
                            </div>
                            <button class="join-room-btn" onclick="event.stopPropagation(); handleJoinRoom('${room.id}')">
                                <i class="fas fa-sign-in-alt"></i> KatÄ±l
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Odalar yÃ¼klenirken hata:', error);
                showStatus('Odalar yÃ¼klenirken hata oluÅtu!', 'error');
            }
        }
        
        async function joinRoom(roomId) {
            try {
                const response = await fetch(`/api/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    currentMember = await response.json();
                    const room = await getRoom(roomId);
                    showRoom(room);
                    
                    // Join socket room
                    socket.emit('join_room', { room_id: roomId, user_id: currentUser.id });
                    
                    showStatus('Odaya katÄ±ldÄ±nÄ±z!', 'success');
                } else {
                    const error = await response.json();
                    if (error.error === 'Invite code required for private room') {
                        const inviteCode = prompt('Bu Ã¶zel oda iÃ§in davet kodu gerekli:');
                        if (inviteCode) {
                            joinRoomWithInvite(roomId, inviteCode);
                        }
                    } else {
                        showStatus(error.error || 'KatÄ±lÄ±m hatasÄ±!', 'error');
                    }
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        async function joinRoomWithInvite(roomId, inviteCode) {
            try {
                const response = await fetch(`/api/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invite_code: inviteCode })
                });
                
                if (response.ok) {
                    currentMember = await response.json();
                    const room = await getRoom(roomId);
                    showRoom(room);
                    
                    socket.emit('join_room', { room_id: roomId, user_id: currentUser.id });
                    showStatus('Odaya katÄ±ldÄ±nÄ±z!', 'success');
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'KatÄ±lÄ±m hatasÄ±!', 'error');
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        async function getRoom(roomId) {
            const response = await fetch(`/api/rooms/${roomId}`);
            return await response.json();
        }
        
        async function joinRoomAfterCreate(roomId) {
            // Oda oluÅturulduktan sonra kullanÄ±cÄ± zaten oda Ã¼yesi olduÄu iÃ§in
            // sadece member bilgisini al
            try {
                const response = await fetch(`/api/rooms/${roomId}/members`);
                const members = await response.json();
                return members.find(m => m.user.id === currentUser.id);
            } catch (error) {
                console.error('Member bilgisi alÄ±nÄ±rken hata:', error);
                return null;
            }
        }
        
        async function loadRoomMembers() {
            try {
                const response = await fetch(`/api/rooms/${currentRoom.id}/members`);
                const members = await response.json();
                
                const participantsCircle = document.getElementById('participantsCircle');
                participantsCircle.innerHTML = members.map(member => {
                    const user = member.user;
                    const isOwner = currentRoom.owner_id === user.id;
                    const isCurrentUser = user.id === currentUser.id;
                    
                    return `
                        <div class="participant-avatar ${member.is_speaking ? 'speaking' : ''} ${member.is_muted ? 'muted' : ''} ${isOwner ? 'owner' : ''}" 
                             data-user-id="${user.id}">
                            ${user.display_name.charAt(0).toUpperCase()}
                            <div class="participant-name">${user.display_name}</div>
                            <div class="participant-status ${member.is_speaking ? 'status-speaking' : member.is_muted ? 'status-muted' : isOwner ? 'status-owner' : ''}">
                                ${member.is_speaking ? 'ð¤' : member.is_muted ? 'ð' : isOwner ? 'ð' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update current member info
                currentMember = members.find(m => m.user.id === currentUser.id);
                updateSpeakingControls();
                
            } catch (error) {
                console.error('Ãyeler yÃ¼klenirken hata:', error);
            }
        }
        
        function updateSpeakingControls() {
            const speakBtn = document.getElementById('speakBtn');
            const muteBtn = document.getElementById('muteBtn');
            const requestSpeakBtn = document.getElementById('requestSpeakBtn');
            
            if (!currentMember) return;
            
            const canSpeak = currentMember.can_speak;
            const isOwner = currentRoom.owner_id === currentUser.id;
            
            if (isOwner) {
                speakBtn.style.display = 'block';
                muteBtn.style.display = 'block';
                requestSpeakBtn.style.display = 'none';
            } else if (canSpeak) {
                speakBtn.style.display = 'block';
                muteBtn.style.display = 'block';
                requestSpeakBtn.style.display = 'none';
            } else {
                speakBtn.style.display = 'none';
                muteBtn.style.display = 'none';
                requestSpeakBtn.style.display = 'block';
            }
        }
        
        // Room creation
        function showCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('active');
        }
        
        function hideCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('active');
        }
        
        async function handleCreateRoom(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        description: formData.get('description'),
                        is_public: formData.get('is_public') === 'true',
                        max_participants: parseInt(formData.get('max_participants'))
                    })
                });
                
                if (response.ok) {
                    const room = await response.json();
                    hideCreateRoomModal();
                    e.target.reset();
                    
                    // Oda oluÅturulduktan sonra otomatik olarak odaya katÄ±l
                    currentMember = await joinRoomAfterCreate(room.id);
                    showRoom(room);
                    
                    // Join socket room
                    socket.emit('join_room', { room_id: room.id, user_id: currentUser.id });
                    
                    showStatus('Oda oluÅturuldu ve odaya katÄ±ldÄ±nÄ±z!', 'success');
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'Oda oluÅturma hatasÄ±!', 'error');
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        // Room controls
        async function handleLeaveRoom() {
            try {
                const response = await fetch(`/api/rooms/${currentRoom.id}/leave`, { method: 'POST' });
                if (response.ok) {
                    currentRoom = null;
                    currentMember = null;
                    showDashboard();
                    showStatus('Odadan Ã§Ä±kÄ±ldÄ±!', 'info');
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'ÃÄ±kÄ±Å hatasÄ±!', 'error');
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        async function handleCloseRoom() {
            if (confirm('OdayÄ± kapatmak istediÄinizden emin misiniz? TÃ¼m katÄ±lÄ±mcÄ±lar odadan Ã§Ä±karÄ±lacak.')) {
                try {
                    const response = await fetch(`/api/rooms/${currentRoom.id}/close`, { method: 'POST' });
                    if (response.ok) {
                        currentRoom = null;
                        currentMember = null;
                        showDashboard();
                        showStatus('Oda kapatÄ±ldÄ±!', 'info');
                    } else {
                        const error = await response.json();
                        showStatus(error.error || 'Oda kapatma hatasÄ±!', 'error');
                    }
                } catch (error) {
                    showStatus('BaÄlantÄ± hatasÄ±!', 'error');
                }
            }
        }
        
        async function handleInvite() {
            try {
                const response = await fetch(`/api/rooms/${currentRoom.id}/invite`, { method: 'POST' });
                if (response.ok) {
                    const invite = await response.json();
                    showInviteModal(invite.invite_code);
                } else {
                    showStatus('Davet kodu oluÅturma hatasÄ±!', 'error');
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        function showInviteModal(inviteCode) {
            const modal = document.getElementById('inviteModal');
            const content = document.getElementById('inviteContent');
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <p>Bu davet kodunu paylaÅÄ±n:</p>
                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px; margin: 1rem 0; font-family: monospace; font-size: 1.2rem; font-weight: bold;">
                        ${inviteCode}
                    </div>
                    <button class="btn" onclick="copyInviteCode('${inviteCode}')">
                        <i class="fas fa-copy"></i> Kopyala
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function hideInviteModal() {
            document.getElementById('inviteModal').classList.remove('active');
        }
        
        function copyInviteCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showStatus('Davet kodu kopyalandÄ±!', 'success');
            });
        }
        
        // Speaking controls
        async function handleSpeak() {
            if (isSpeaking) {
                // Stop speaking
                socket.emit('stop_speaking', { room_id: currentRoom.id, user_id: currentUser.id });
                isSpeaking = false;
                document.getElementById('speakBtn').innerHTML = '<i class="fas fa-microphone"></i> KonuÅ';
            } else {
                // Start speaking
                socket.emit('start_speaking', { room_id: currentRoom.id, user_id: currentUser.id });
                isSpeaking = true;
                document.getElementById('speakBtn').innerHTML = '<i class="fas fa-stop"></i> Durdur';
            }
        }
        
        async function handleMute() {
            isMuted = !isMuted;
            socket.emit('toggle_mute', { 
                room_id: currentRoom.id, 
                user_id: currentUser.id, 
                is_muted: isMuted 
            });
            
            const muteBtn = document.getElementById('muteBtn');
            if (isMuted) {
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i> SusturmayÄ± KaldÄ±r';
                muteBtn.classList.remove('mute-btn');
            } else {
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i> Sustur';
                muteBtn.classList.add('mute-btn');
            }
        }
        
        async function handleRequestSpeak() {
            try {
                const response = await fetch(`/api/rooms/${currentRoom.id}/request-speak`, { method: 'POST' });
                if (response.ok) {
                    showStatus('KonuÅma isteÄi gÃ¶nderildi!', 'info');
                } else {
                    const error = await response.json();
                    showStatus(error.error || 'Ä°stek gÃ¶nderme hatasÄ±!', 'error');
                }
            } catch (error) {
                showStatus('BaÄlantÄ± hatasÄ±!', 'error');
            }
        }
        
        // Speaking requests modal
        function showRequestsModal() {
            loadSpeakingRequests();
            document.getElementById('requestsModal').classList.add('active');
        }
        
        function hideRequestsModal() {
            document.getElementById('requestsModal').classList.remove('active');
        }
        
        async function loadSpeakingRequests() {
            try {
                const response = await fetch(`/api/rooms/${currentRoom.id}/speaking-requests`);
                const requests = await response.json();
                
                const requestsList = document.getElementById('requestsList');
                if (requests.length === 0) {
                    requestsList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6);">Bekleyen istek yok.</p>';
                } else {
                    requestsList.innerHTML = requests.map(req => `
                        <div class="request-item">
                            <div class="request-user">
                                <div class="owner-avatar">${req.user.display_name.charAt(0).toUpperCase()}</div>
                                <span>${req.user.display_name}</span>
                            </div>
                            <div class="request-actions">
                                <button class="approve-btn" onclick="approveSpeak('${req.user_id}')">Onayla</button>
                                <button class="reject-btn" onclick="rejectSpeak('${req.user_id}')">Reddet</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Ä°stekler yÃ¼klenirken hata:', error);
            }
        }
        
        async function approveSpeak(userId) {
            try {
                await fetch(`/api/rooms/${currentRoom.id}/approve-speak/${userId}`, { method: 'POST' });
                loadSpeakingRequests();
                showStatus('KonuÅma yetkisi verildi!', 'success');
            } catch (error) {
                showStatus('Onaylama hatasÄ±!', 'error');
            }
        }
        
        async function rejectSpeak(userId) {
            try {
                await fetch(`/api/rooms/${currentRoom.id}/reject-speak/${userId}`, { method: 'POST' });
                loadSpeakingRequests();
                showStatus('KonuÅma isteÄi reddedildi!', 'info');
            } catch (error) {
                showStatus('Reddetme hatasÄ±!', 'error');
            }
        }
        
        // Utility functions
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.classList.add('show');
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }
        
        // Socket.IO event listeners
        socket.on('members_updated', function(members) {
            if (currentRoom) {
                loadRoomMembers();
            }
        });
        
        socket.on('speaking_request', function(request) {
            if (currentRoom && currentRoom.owner_id === currentUser.id) {
                showStatus(`${request.user.display_name} konuÅma istiyor!`, 'info');
            }
        });
        
        socket.on('speaking_approved', function(data) {
            if (data.user_id === currentUser.id) {
                showStatus('KonuÅma yetkiniz onaylandÄ±!', 'success');
                loadRoomMembers();
            }
        });
        
        socket.on('speaking_rejected', function(data) {
            if (data.user_id === currentUser.id) {
                showStatus('KonuÅma isteÄiniz reddedildi.', 'error');
            }
        });
        
        socket.on('user_started_speaking', function(data) {
            const avatar = document.querySelector(`[data-user-id="${data.user_id}"]`);
            if (avatar) {
                avatar.classList.add('speaking');
            }
        });
        
        socket.on('user_stopped_speaking', function(data) {
            const avatar = document.querySelector(`[data-user-id="${data.user_id}"]`);
            if (avatar) {
                avatar.classList.remove('speaking');
            }
        });
        
        socket.on('user_mute_toggled', function(data) {
            const avatar = document.querySelector(`[data-user-id="${data.user_id}"]`);
            if (avatar) {
                if (data.is_muted) {
                    avatar.classList.add('muted');
                } else {
                    avatar.classList.remove('muted');
                }
            }
        });
        
        socket.on('room_closed', function(data) {
            if (currentRoom && currentRoom.id === data.room_id) {
                currentRoom = null;
                currentMember = null;
                showDashboard();
                showStatus('Oda kapatÄ±ldÄ±!', 'info');
            }
        });
    </script>
</body>
</html>
